import{d as Y,s as $,r as T,n as z,o as Q,a as Z,b as x,w as I,c as C,e as n,F,f as V,g as A,v as U,h as P,i as j,u as g,j as L,k as G,l as W,m as H,T as ee,p as J,q as _,t as te,x as N,_ as se}from"./index-CxhtOLru.js";import{u as O}from"./useSettingStore-BzqOtbVG.js";import{u as le}from"./useDataStore-CiqW6bRx.js";const q=Y("typing",()=>{const{allWords:e}=$(O()),m=T(null),u=T([]),w=T([]);function k(l){const s=JSON.parse(JSON.stringify(e.value));if(!s){console.error("当前无词块");return}s.length<l&&(console.error(`可用词块数不足${l}个！当前最多生成${s.length}个词块`),l=s.length),u.value=[];for(let r=0;r<l;r++){const c=Math.floor(Math.random()*s.length),i=s.splice(c,1)[0];u.value.push(i)}w.value=u.value.map(({cn:r,...c})=>c)}const a=T(null),o=T([]),f=T(null),d=(l,s)=>{l&&(o.value[s]=l)};function p(){o.value=[];for(let l=0;l<u.value.length;l++){const s=o.value[l];s&&o.value.push(s)}}return{words:u,caret:a,blockRefs:o,enWords:w,startTime:m,blocksContainer:f,setBlockRef:d,generateWords:k,updateRefs:p}});function oe(e){const{blockRefs:m,caret:u}=$(q()),w=()=>{const o=m.value[e.value[0]];if(!o){console.error("Block元素未定义");return}k(e.value[1],o)},k=(o,f)=>{if(!f){console.error("Block元素不存在");return}const p=f.children[1].children;if(p.length<o){console.error(`Block中不足${o}个code`);return}const l=p[o]||p[o-1];a(l,o!=p.length)};function a(o,f){const d=u.value;if(!d){console.error("CaretElement元素不存在");return}const p=o.offsetTop+o.offsetHeight/2-d.offsetHeight/2,l=o.offsetLeft+(f?0:o.offsetWidth);d.style.transform=`translate(${l}px, ${p}px)`}return{handleTyping:w}}function ne(e,m){const{words:u,blockRefs:w,caret:k,enWords:a,startTime:o}=$(q());function f(){var s,r;(s=k.value)==null||s.classList.remove("hide"),(r=k.value)==null||r.classList.add("waiting")}function d(){var s;(s=k.value)==null||s.classList.add("hide")}function p(s){const{codeElements:r,cn:c}=l(e.value[0]);if(k.value&&k.value.classList.remove("waiting"),s.code.startsWith("Key")){if(o.value||(o.value=Date.now()),a.value[e.value[0]].typing?a.value[e.value[0]].typing+=s.key:a.value[e.value[0]].typing=s.key,e.value[1]!=r.length){const i=r[e.value[1]];i.classList.add(s.key==a.value[e.value[0]].en[e.value[1]]?"correct":"wrong"),i.classList.remove("skip")}u.value.length<=e.value[0]&&console.error("block索引越界"),e.value[1]<u.value[e.value[0]].en.length?e.value[0]==u.value.length-1&&e.value[1]==a.value[e.value[0]].en.length-1?m(a.value):e.value[1]++:u.value.length>e.value[0]+1?(u.value[e.value[0]].en+=s.key,z(()=>{r[e.value[1]].classList.add("wrong"),e.value[1]++})):m(a.value)}else if(s.code==="Space")e.value[1]!=0&&(e.value[0]<u.value.length-1?([...r].slice(e.value[1],r.length).forEach(h=>h.classList.add("skip")),a.value[e.value[0]].isCorrect=a.value[e.value[0]].typing==a.value[e.value[0]].en,c.classList.toggle("wrong",!a.value[e.value[0]].isCorrect),c.classList.toggle("correct",a.value[e.value[0]].isCorrect),e.value=[e.value[0]+1,0]):m(a.value));else if(s.code==="Backspace"){if(e.value[0]==0&&e.value[1]==0)return;if(e.value[1]<=0){const{codeElements:i,cn:h}=l(e.value[0]-1),y=[...i];if(h.classList.remove("wrong","correct"),a.value[e.value[0]-1].isCorrect=void 0,y.filter(b=>b.classList.contains("skip")).length>0){let b;for(let t=0;t<y.length;t++)if(y[t].classList.contains("skip")){b=t;break}y.slice(b,y.length).forEach(t=>t.classList.remove("skip")),b?e.value=[e.value[0]-1,b]:console.error("索引元素不存在")}else e.value=[e.value[0]-1,u.value[e.value[0]-1].en.length]}else{const i=a.value[e.value[0]].typing;i&&(a.value[e.value[0]].typing=i.slice(0,-1)),e.value[1]>a.value[e.value[0]].en.length?(u.value[e.value[0]].en=u.value[e.value[0]].en.slice(0,-1),z(()=>e.value[1]--)):(e.value[1]--,r[e.value[1]].classList.remove("correct","wrong"))}}}function l(s){const r=w.value[s];if(!r){console.error("Block元素不存在");return}const c=r.children[0],h=r.children[1].children;return{cn:c,codeElements:h}}return{startTyping:f,endTyping:d,typing:p,startTime:o}}function ae(e,m,u){const{settings:w}=O(),{generateWords:k,updateRefs:a}=q(),{words:o,startTime:f,blocksContainer:d,blockRefs:p}=$(q());function l(c){c[m.value[0]].isCorrect=c[m.value[0]].typing==c[m.value[0]].en;const i=Date.now();if(!f.value){console.error("计时未开始");return}const h=(i-f.value)/1e3,y=Math.round(h)+"s",E=c.filter(D=>D.isCorrect).length;let b=E/h*60;b=Math.round(b*100)/100;const B=b.toFixed(2);let t=E/o.value.length;t=Math.round(t*100);const S=t+"%";e.value.wpm=B,e.value.correctness=S,e.value.during=y,u.value=!0;const{addTypingRecord:K}=le();K({wpm:parseFloat(B),timestamp:new Date().toLocaleString(),mode:"timed",total_words:c.length,accuracy:t})}function s(c){p.value.forEach(i=>{i.children[0].classList.remove("wrong","correct","skip"),[...i.children[1].children].forEach(y=>{y.classList.remove("wrong","correct","skip")})}),f.value=null,r(c),u.value=!1,z(()=>{d.value&&d.value.focus(),m.value=[0,0]})}function r(c){a(),k(c)}return k(w.generateWordsNum),Q(()=>{f.value=null}),{handleEnd:l,restart:s}}const re={class:"items-center column"},ie={class:"q-ma-lg num-chooser"},ue={key:0,class:"num-chooser-split"},ce=["onClick"],ve={class:"items-center column q-mt-xl"},fe={class:"cn-word"},pe={class:"en-word"},de={class:"result items-center column q-mt-xl"},ge={class:"row justify-around result-item-container"},me={class:"result-item"},ke={class:"result-key row items-center"},he={class:"result-value correct"},we={class:"result-item"},ye={class:"result-value correct"},be={class:"result-item"},Te={class:"result-value correct"},Ce=Z({__name:"TimeKeep",setup(e){const{words:m,caret:u,blocksContainer:w,startTime:k}=$(q()),{setBlockRef:a}=q(),{settings:o}=O(),f=T(!1),d=T({wpm:"",correctness:"",during:""}),p=T([0,0]),l=T(o.generateWordsNum),s=T([20,30,40,50]),{handleTyping:r}=oe(p),{handleEnd:c,restart:i}=ae(d,p,f),{startTyping:h,endTyping:y,typing:E}=ne(p,c);function b(B){l.value!=B&&(l.value=B,i(l.value))}return z(()=>{w.value&&w.value.focus()}),x(()=>{window.addEventListener("resize",r),I(p,()=>{r()},{deep:!0,immediate:!0})}),Q(()=>{window.removeEventListener("resize",r)}),(B,t)=>{const S=J("q-btn"),K=J("q-tooltip"),D=J("q-icon");return _(),C("div",re,[n("div",ie,[(_(!0),C(F,null,V(s.value,(v,R)=>(_(),C("span",{key:R},[R!=0?(_(),C("span",ue,"/")):te("",!0),n("span",{onClick:M=>b(v),class:G([l.value==v?"correct":"","num-chooser-num"])},N(v),11,ce)]))),128))]),A(n("div",ve,[n("div",{ref_key:"blocksContainer",ref:w,onKeydown:[t[0]||(t[0]=P(j(()=>{},["prevent"]),["space"])),t[3]||(t[3]=(...v)=>g(E)&&g(E)(...v))],onFocus:t[1]||(t[1]=(...v)=>g(h)&&g(h)(...v)),onBlur:t[2]||(t[2]=(...v)=>g(y)&&g(y)(...v)),onClick:t[4]||(t[4]=(...v)=>g(r)&&g(r)(...v)),tabindex:"0",class:"row words-container"},[n("div",{ref_key:"caret",ref:u,class:"caret"},null,512),(_(!0),C(F,null,V(g(m),(v,R)=>(_(),C("div",{ref_for:!0,ref:M=>g(a)(M,R),key:R,class:"column items-center word-block"},[n("div",fe,N(v.cn),1),n("div",pe,[(_(!0),C(F,null,V(v.en,(M,X)=>(_(),C("code",{key:X},N(M),1))),128))])]))),128))],544),L(S,{onKeydown:t[5]||(t[5]=P(j(v=>g(i)(l.value),["prevent"]),["space"])),onClick:t[6]||(t[6]=v=>g(i)(l.value)),class:"re-btn",padding:"xl",icon:"refresh",size:"lg",unelevated:""}),n("div",{class:G([g(k)?"transport":"","tip column q-mt-xl items-center"])},[t[13]||(t[13]=n("span",null,"点击词块即可开始输入",-1)),n("span",null,[t[9]||(t[9]=W("按")),L(S,{padding:"0px 3px",push:"",label:"Space"}),t[10]||(t[10]=W("进入下一个词块"))]),t[14]||(t[14]=n("span",null,"输入第一个字母后开始计时",-1)),n("span",null,[L(S,{padding:"0px 3px",push:"",label:"Tab"}),t[11]||(t[11]=W("+")),L(S,{padding:"0px 3px",push:"",label:"Space"}),t[12]||(t[12]=W("可以快速刷新"))])],2)],512),[[U,!f.value]]),L(ee,{name:"result"},{default:H(()=>[A(n("div",de,[n("div",ge,[n("div",me,[n("div",ke,[t[16]||(t[16]=W(" WPM ")),L(D,{color:"text",class:"q-ml-xs cursor-pointer",name:"info"},{default:H(()=>[L(K,{"transition-show":"scale","transition-hide":"scale",class:"text-btnText bg-active",anchor:"top middle",self:"bottom middle",offset:[10,10]},{default:H(()=>t[15]||(t[15]=[n("b",null,[n("em",{style:{"text-decoration":"underline","font-size":"14px"}},"Words Per Minute")],-1),n("br",null,null,-1),n("span",{style:{"font-size":"13px"}},"每分钟键入的单词数",-1)])),_:1})]),_:1})]),n("div",he,N(d.value.wpm),1)]),n("div",we,[t[17]||(t[17]=n("div",{class:"result-key"},"正确率",-1)),n("div",ye,N(d.value.correctness),1)]),n("div",be,[t[18]||(t[18]=n("div",{class:"result-key"},"用时",-1)),n("div",Te,N(d.value.during),1)])]),L(S,{onKeydown:t[7]||(t[7]=P(j(v=>g(i)(l.value),["prevent"]),["space"])),onClick:t[8]||(t[8]=v=>g(i)(l.value)),class:"re-btn",padding:"xl",icon:"refresh",size:"lg",unelevated:""})],512),[[U,f.value]])]),_:1})])}}}),Se=se(Ce,[["__scopeId","data-v-97b8c70c"]]);export{Se as default};
